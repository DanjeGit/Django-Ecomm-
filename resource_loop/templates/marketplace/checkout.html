{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container py-5">
  <h2 class="fw-bold mb-4">Checkout</h2>

  {% if cart_items %}
  <div class="row g-4">
    <div class="col-lg-8">
      {% for ci in cart_items %}
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden mb-3">
        <div class="card-body p-4 d-flex align-items-center">
          <div class="me-4">
            {% if ci.item.image %}
            <img src="{{ ci.item.image.url }}" style="width:80px;height:80px;object-fit:cover;" class="rounded-3" alt="{{ ci.item.title }}">
            {% else %}
            <div class="bg-light rounded-3 d-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                <i class="fa-solid fa-image text-muted"></i>
            </div>
            {% endif %}
          </div>
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-1 fw-bold">{{ ci.item.title }}</h5>
                <div class="text-muted small">Qty: {{ ci.quantity }}</div>
              </div>
              <div class="text-end">
                <div class="text-muted small">Price</div>
                <div class="fw-bold text-primary">KSh {{ ci.item.price|floatformat:2 }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
        <div class="card-body p-4">
          <h5 class="card-title fw-bold mb-4">Order Summary</h5>
          <ul class="list-group list-group-flush mb-4">
            <li class="list-group-item d-flex justify-content-between px-0 border-bottom-0 pb-2">
              <span class="text-muted">Subtotal</span>
              <span class="fw-bold">KSh {{ subtotal|floatformat:2 }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between px-0 border-bottom-0 pt-0">
              <span class="text-muted">Shipping</span>
              <span class="fw-bold" id="shippingDisplay">Calculated at checkout</span>
            </li>
            <li class="list-group-item d-flex justify-content-between px-0 border-top pt-3 mt-2">
              <span class="fw-bold fs-5">Total</span>
              <span class="fw-bold fs-5 text-primary" id="totalDisplay">KSh {{ subtotal|floatformat:2 }}</span>
            </li>
          </ul>
          
          <div class="mt-4">
            <div id="paymentStatus" class="alert d-none rounded-3" role="alert"></div>
            
            <div class="mb-4">
                <label for="pickupStationSelect" class="form-label fw-bold">Select Pickup Station</label>
                <select class="form-select" id="pickupStationSelect" required>
                    <option value="" data-fee="0" selected disabled>Choose a location...</option>
                    {% for station in pickup_stations %}
                    <option value="{{ station.id }}" data-fee="{{ station.shipping_fee }}">
                        {{ station.name }} - {{ station.county }} (KSh {{ station.shipping_fee }})
                    </option>
                    {% endfor %}
                </select>
                <div class="form-text text-muted">Select your station for fee calculation.</div>
            </div>

            <div class="bg-light p-4 rounded-4 mb-3">
                <h6 class="fw-bold mb-3">Select Payment Method</h6>
                
                <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active rounded-pill" id="pills-mpesa-tab" data-bs-toggle="pill" data-bs-target="#pills-mpesa" type="button" role="tab" aria-selected="true">M-Pesa</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link rounded-pill" id="pills-airtel-tab" data-bs-toggle="pill" data-bs-target="#pills-airtel" type="button" role="tab" aria-selected="false">Airtel Money</button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link rounded-pill" id="pills-card-tab" data-bs-toggle="pill" data-bs-target="#pills-card" type="button" role="tab" aria-selected="false">Card</button>
                  </li>
                </ul>

                <div class="tab-content" id="pills-tabContent">
                  <!-- M-Pesa -->
                  <div class="tab-pane fade show active" id="pills-mpesa" role="tabpanel">
                    <form id="stkForm" method="post" action="{% url 'mpesa_stk_push' %}">
                      {% csrf_token %}
                      <input type="hidden" name="payment_method" value="mpesa">
                      <input type="hidden" name="pickup_station_id" id="hiddenPickupStationId">
                      <div class="mb-3">
                        <label class="form-label small fw-bold text-muted text-uppercase">M-Pesa Phone Number</label>
                        <input type="tel" name="phone_number" class="form-control form-control-lg border-0 bg-white" placeholder="e.g. 07XXXXXXXX" value="{{ request.user.buyerprofile.phone_number|default:'' }}" required>
                      </div>
                      <input type="hidden" name="amount" id="hiddenAmount" value="{{ subtotal }}">
                      <button id="stkSubmit" type="submit" class="btn btn-success btn-lg w-100 rounded-pill shadow-sm" disabled>
                        Pay with M-Pesa
                      </button>
                    </form>
                    <small class="text-muted d-block mt-3 text-center" style="font-size: 0.8rem;">
                        <i class="fa-solid fa-circle-info me-1"></i> You will receive an M-Pesa prompt on your phone.
                    </small>
                  </div>

                  <!-- Airtel Money -->
                  <div class="tab-pane fade" id="pills-airtel" role="tabpanel">
                     <div class="text-center py-3">
                        <i class="fa-solid fa-mobile-screen fa-2x text-danger mb-2"></i>
                        <p class="text-muted">Airtel Money integration coming soon.</p>
                     </div>
                  </div>

                  <!-- Card -->
                  <div class="tab-pane fade" id="pills-card" role="tabpanel">
                    <div class="text-center py-3">
                        <i class="fa-regular fa-credit-card fa-2x text-primary mb-2"></i>
                        <p class="text-muted">Card payments are currently unavailable.</p>
                    </div>
                  </div>
                </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="text-center py-5">
      <i class="fa-solid fa-cart-shopping fa-3x text-muted mb-3 opacity-50"></i>
      <p class="text-muted">Your cart is empty.</p>
      <a href="{% url 'index' %}" class="btn btn-primary rounded-pill px-4">Start Shopping</a>
  </div>
  {% endif %}
</div>
<script>
  (function(){
    const form = document.getElementById('stkForm');
    const submitBtn = document.getElementById('stkSubmit');
    const alertBox = document.getElementById('paymentStatus');
    
    // Shipping Calculation Logic
    const subtotal = parseFloat("{{ subtotal|stringformat:'f' }}");
    const stationSelect = document.getElementById('pickupStationSelect');
    const shippingDisplay = document.getElementById('shippingDisplay');
    const totalDisplay = document.getElementById('totalDisplay');
    const hiddenAmount = document.getElementById('hiddenAmount');
    const hiddenStationId = document.getElementById('hiddenPickupStationId');

    if (stationSelect) {
        stationSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const fee = parseFloat(selectedOption.dataset.fee || 0);
            const stationId = this.value;

            // Update displays
            shippingDisplay.textContent = 'KSh ' + fee.toFixed(2);
            const newTotal = subtotal + fee;
            totalDisplay.textContent = 'KSh ' + newTotal.toFixed(2);

            // Update form inputs
            if (hiddenAmount) hiddenAmount.value = newTotal;
            if (hiddenStationId) hiddenStationId.value = stationId;

            // Enable submit
            if (submitBtn) submitBtn.disabled = false;
        });
    }

    if (!form) return;

    function showAlert(cls, msg){
      alertBox.className = 'alert ' + cls;
      alertBox.textContent = msg;
      alertBox.classList.remove('d-none');
    }

    function pollStatus(retries, checkoutRequestId){
      let url = '{% url "payment_status" %}';
      if (checkoutRequestId) {
        url += '?checkout_request_id=' + checkoutRequestId;
      }

      fetch(url, {credentials: 'same-origin'})
        .then(r=>r.json())
        .then(data => {
          const {pending, confirmed, cancelled} = data;
          
          if (confirmed > 0) {
            showAlert('alert-success', 'Payment Confirmed! Your order has been placed successfully.');
            setTimeout(()=>{ window.location.href = '{% url "purchase_history" %}'; }, 3000);
            return;
          } else if (cancelled > 0) {
            showAlert('alert-danger', 'Payment was cancelled or failed. Please try again.');
            submitBtn.disabled = false;
            return;
          }
          
          if (retries > 0) {
             setTimeout(()=> pollStatus(retries-1, checkoutRequestId), 5000);
          } else {
             showAlert('alert-warning', 'Payment verification timed out. If you paid, please check your Order History. Otherwise, please try again.');
             submitBtn.disabled = false;
          }
        })
        .catch(()=>{
          if (retries > 0) setTimeout(()=> pollStatus(retries-1, checkoutRequestId), 5000);
          else submitBtn.disabled = false;
        });
    }

    form.addEventListener('submit', function(e){
      e.preventDefault();
      submitBtn.disabled = true;
      showAlert('alert-warning', 'Initiating payment… Please approve the STK prompt on your phone.');
      const formData = new FormData(form);
      fetch(form.action, {
        method: 'POST',
        body: formData,
        credentials: 'same-origin'
      })
      .then(r => r.json())
      .then(data => {
        if (data && !data.error) {
          showAlert('alert-info', 'STK push sent. Waiting for confirmation…');
          const checkoutRequestId = data.CheckoutRequestID;
          pollStatus(40, checkoutRequestId); // ~2 minutes
        } else {
          showAlert('alert-danger', (data && data.error) || 'Failed to initiate payment.');
          submitBtn.disabled = false;
        }
      })
      .catch(() => {
        showAlert('alert-danger', 'Network error. Please try again.');
        submitBtn.disabled = false;
      });
    });
  })();
</script>
{% endblock %}
